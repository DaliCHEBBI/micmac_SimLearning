\chapter{SysCo manipulation}
\label{Chap:SysCo}


%-----------------------------------------------------------------------
%-----------------------------------------------------------------------
%-----------------------------------------------------------------------

\section{SysCo introduction}

Coordinate systems (SysCo) types supported by {\tt MMVII} are:
\begin{itemize}
\item \textbf{Local}: any euclidian frame, without any geolocalization or vertical knowledge.
\item \textbf{GeoC}: geocentric coordinates.
\item \textbf{LGeo}: a local euclidian frame with an affine transformation into geocentric coordinates.
\item \textbf{RTL}: a special case of LGeo where the local frame is defined by an origin point, where Z is ellipsoid normal at origin and X is East.
\item \textbf{Proj}: any georeferenced system handled by {\tt libproj} (including geographical coordinates).
\end{itemize}

When the SysCo is known or declared for an Ori or Measures folder, a file named {\tt CurSysCo.xml}
is created to record it.

This file can be copied into {\tt MMVII-PhgrProj/SysCo/} with a short name to be used in next commands.
Example: copy {\tt CurSysCo.xml} as {\tt MMVII-PhgrProj/SysCo/MyCRS.xml}, to be able to use {\tt MyCRS}
as a SysCo name.

\section{Setting SysCo}

\subsection{MMVII Commands}
To inform {\tt MMVII} of the SysCo of some data, there are several methods:

\begin{itemize}
\item Some importation commands have an implicit SysCo, e.g. {\tt ImportInitExtSens} that suppose that RPC are always in WGS geographical coordinates in degrees.
\item {\tt ImportOri} let you tell the SysCo with {\tt SysCo} option.
\item {\tt ImportGCP} let you transform ground coordinates on-the-fly with {\tt ChSys} option.
\item {\tt OriChSysCo} and {\tt GCPChSysCo} let you transform Ori and ground points from one SysCo into an other.
\end{itemize}

\subsection{SysCo definition}
The SysCo definitions to give to {\tt MMVII} commands can be:
\begin{itemize}
\item The name of a file in source sub-folder {\tt MMVII/MMVII-RessourceDir/SysCo} or in project sub-folder {\tt MMVII-PhgrProj/SysCo}, without its extension.
\item Any {\tt libproj} definition (such as {\tt IGNF:LAMB93}, {\tt EPSG:4326} or {\tt '+proj=merc +lat\_ts=56.5 +ellps=GRS80'})
\item Any string starting with {\tt Local} for a local frame
\item Any string starting with {\tt GeoC} for geocentric
\item A string starting with {\tt LGeo}, with the pattern:

{\tt LGeo*TX*TY*TZ*Omega*Phi*Kappa}, where the transformation is given in geocentric, the angles are in rad. 
\item A string starting with {\tt RTL}, with the pattern: {\tt RTL*X0*Y0*Z0*Def}

(such as {\tt RTL*0.67451979*45.18899334*0.00000000*EPSG:4326}),
where you give the coordinates in a certain system of the tengance point of the local frame. Tip: use {\tt SysCoCreateRTL} command to make it automatically (see ~\ref{SysCoRTL}).

\end{itemize}


\subsection{Examples}
\begin{itemize}
\item {\tt SysCo=L93} will set the SysCo to Lambert93 (IGNF:LAMB93), as definied in \\
{\tt MMVII/MMVII-RessourceDir/SysCo/L93.xml}.
\item {\tt SysCo=LocalPanel} will set the SysCo to a local system definied as "LocalPanel", that will not be convertible into any other SysCo.
\item {\tt SysCo=IGNF:LAMB93} will set the SysCo to Lambert93.
\item {\tt SysCo=RTL*0.67451979*45.18899334*0*EPSG:4326} will set the SysCo to a tangent local euclidian frame where origin is $0.67451979, 45.18899334, 0$ in EPSG:4326.
\item {\tt SysCo=Toto} will use a project-defined SysCo if {\tt MMVII-PhgrProj/SysCo/Toto.xml} exists. If not, "Toto" will be used as a libproj definition, and an error will occur.
\item {\tt SysCo=GeoC} will set the SysCo to geocentric coordinates.

\end{itemize}


\section{RTL SysCo}
\label{SysCoRTL}
{\tt MMVII} suppose that the coordinates used during bundle adjustment are euclidian.

To keep small coordinates, a Local tangent frame (RTL) can be defined.

{\tt SysCoCreateRTL} command do that from an Ori, using as tangence point the average of canera positions or a fixed point.

It creates a file with the chosen name in {MMVII-PhgrProj/SysCo/}.

Then every Ori and ground measures can be transformed into this RTL frame to be able to keep maximal precision during bundle adjustment.


%-----------------------------------------------------------------------
%-----------------------------------------------------------------------
%-----------------------------------------------------------------------


\chapter{Topometric compensation (WIP)}
\label{Chap:TopoUser}


\section{Topometry introduction}

{\tt MMVII} supports the following topometric/surveying measurements types in global adjustments:

\begin{itemize}
    \item distances
    \item pseudo-horizontal angles
    \item pseudo-vertical angles
    %\item cartesian vector in a sub-frame
    %\item height differences
\end{itemize}

These measurements are made in regard to the gravitation field if the instruments are vericalized.
For now, the vertical is modeled as the Earth's ellipsoid normal. Vertical deflection grids may be added later.

The measurements are between named points that can be:
\begin{itemize}
    \item GCPs
    \item camera summits
    \item points declared in topo file
    \item implicitly declared points in observations files.
\end{itemize}


Two {\tt MMVII} commands can use these measurements in compensation:
\begin{itemize}
    \item {\tt OriBundleAdj} via the {\tt TopoFile} option
    \item {\tt TopoAdj} (see below)
\end{itemize}

The topo measurements file can be given as a {\tt MMVII} json or xml file, or in a simplified text format (named {\tt obs} file) inherited from IGN's Comp3D compensation software.

The {\tt MMVII} topo files record all the input and output data, organized as the internal {\tt MMVII} objects during compensation.
The {\tt obs} format is simplified and easily human-editable. It is the preferred input format for simple station-based measurements.


\section{{\tt obs} file format}

The {\tt obs} file format is limited to station-based measurements where the station in verticalized.
{\tt MMVII} supports only a subset of Comp3D format.

{\tt obs} files are text files with fields delimited by any number of spaces or tabs. Blank lines are overlooked.
The {\tt *} character defines a comment that goes up to the end of the line.

Example:

\begin{verbatim}
    7 St1 Or1   0.0000 0.0010 * horizontal reference
    6 St1 Or1 100.0000 0.0010 * zenithal angle
    3 St1 Or1  20.0000 0.0010 * distance

    5 St1  E1  100.0000 0.0010 * horizontal angle
    6 St1  E1  100.0000 0.0010
    3 St1  E1 1000.0000 0.0010
\end{verbatim}

An observation line is composed by:

\begin{itemize}
    \item code: an integer representing the type of observation (see below)
    \item station name
    \item target name
    \item measurement value (in meters for distances, in gon for angles)
    \item measurement a priori $\sigma$ (in meters for distances, in gon for angles)
    \item anything else is ignored until the end of the line
\end{itemize}

The observations codes are:

\begin{itemize}
    \item 3: 3d distance
    \item 5: horizontal angle (relative to the last horizontal reference on the same station)
    \item 6: zenithal angle
    \item 7: horizontal reference
\end{itemize}

In the previous example, {\tt St1}, {\tt Or1} and {\tt E1} are points name.
They can refer to GCP, cameras or undefined points.

\section{{\tt TopoAdj} command}

The {\tt TopoAdj} command can perform an adjustment between topometric and GCP constraints.
It is used as a substitute to {\tt OriBundleAdj} when there are no cameras.

\begin{verbatim}
  For command : TopoAdj 
   => Topo adjustment
   => Srce code entry in :/home/JMMuller/micmac/MMVII/src/BundleAdjustment/cAppliTopoAdj.cpp

 == Mandatory unnamed args : ==
  * string [FileAny] :: Topo obs file path
  * string [PointsMeasure,In] :: Input PointsMeasure
  * string [PointsMeasure,Out] :: Output PointsMeasure
  * double :: Constrained GCP Weight

 == Optional named args : ==
  * [Name=DataDir] string :: Defautl data directories  ,[Default=Std]
  * [Name=NbIter] int :: Number of iterations ,[Default=10]
  * [Name=GCPFilter] string :: Pattern to filter GCP by name
  * [Name=GCPFilterAdd] string :: Pattern to filter GCP by additional info
  * [Name=GCPDirOut] string [PointsMeasure,Out] :: Dir for output GCP
  * [Name=LVM] double :: Levenbergâ€“Marquardt parameter (to have better conditionning of least squares) ,[Default=0]
\end{verbatim}

